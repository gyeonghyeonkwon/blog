<html layout:decorate="~{layout/layout.html}" xmlns:layout="http://www.w3.org/1999/xhtml"
      xmlns:display="http://www.w3.org/1999/xhtml">
<div layout:fragment="content"
     class="flex justify-center items-center min-h-screen bg-gray-100 content">
  <div class="card w-96 bg-white shadow-xl">
    <div class="card-body">
      <h2 class="text-center text-2xl font-bold mb-3">회원가입</h2>
      <form id="form" th:action="@{/member/signup}" th:object="${memberJoinRequest}"
            th:method="post">
        <!-- 아이디 -->
        <label class="form-control w-full max-w-xs">
          <div class="label">
            <span class="label-text">아이디</span>
          </div>
          <div class="flex">
            <input type="text" id="login-id" name="loginId" th:field="*{loginId}" placeholder="아이디를 입력하세요"
                   class="input input-bordered w-full max-w-xs mr-1">
            <button class="btn btn-active" id="check-duplicate-btn" type="button">중복검사</button>
          </div>
          <p id="id-check-msg"></p>
          <span id="id-ok" style="color: green; display: none">사용가능한아이디입니다.</span>
          <span id="id-already" style="color: red; display: none">다른아이디를사용해주세요.</span>
        </label>

        <!-- 이름 -->
        <label class="form-control w-full max-w-xs">
          <div class="label">
            <span class="label-text">이름</span>
          </div>
          <input type="text" id="real-name" name="realName" th:field="*{realName}" placeholder="이름을 입력하세요"
                 class="input input-bordered w-full max-w-xs" required>
          <p id="real-name-check-msg"></p>
        </label>

        <!-- 이메일 -->
        <label class="form-control w-full max-w-xs">
          <div class="label">
            <span class="label-text">이메일</span>
          </div>
          <div class="flex">
            <input type="email" id="email" name="email" th:field="*{email}" placeholder="이메일을 입력하세요"
                   class="input input-bordered w-full max-w-xs mr-1" required>
            <button class="btn btn-active" type="button" id="send-code-btn">인증번호전송</button>
          </div>
            <p id="email-check-msg"></p>
          <div class="mt-3 flex">
            <input type="text" id="verification-code" name="verificationCode" th:field="*{verificationCode}" placeholder="인증번호 6자리를 입력하세요"
                   class="input input-bordered w-full max-w-xs mr-1" maxlength="6" required>
            <button class="btn btn-active" type="button" id="verify-code-btn">인증확인</button>
          </div>
            <p id="verification-code-msg"></p>
            <p id="verification-success-msg" style="display: none; color: green">인증에 성공하였습니다.</p>
            <p id="verification-fail-msg" style="display: none; color: red">인증에 실패하였습니다.</p>
        </label>

        <!-- 비밀번호 -->
        <label class="form-control w-full max-w-xs">
          <div class="label">
            <span class="label-text">비밀번호</span>
          </div>
          <input type="password" id="password" name="password" th:field="*{password}" placeholder="비밀번호를 입력하세요"
                 class="input input-bordered w-full max-w-xs" required>
        </label>

        <!-- 비밀번호 확인 -->
        <label class="form-control w-full max-w-xs">
          <div class="label">
            <span class="label-text">비밀번호 확인</span>
          </div>
          <input type="password" id="password-confirm" name="passwordConfirm" th:field="*{passwordConfirm}"
                 placeholder="비밀번호를 다시 입력하세요" class="input input-bordered w-full max-w-xs" required>
          <p id="password-check-msg"></p>
        </label>

        <!-- 회원가입 버튼 -->
        <div class="form-control mt-6">
          <button type="submit" id="submit-btn" class="btn btn-primary">회원가입</button>
        </div>
      </form>
    </div>
  </div>

  <th:block layout:fragment="script">
    <script th:inline="javascript">
      const idCheck = document.getElementById('idCheck');
      const password = document.getElementById('password');
      const confirmPassword = document.getElementById('password-confirm');
      const passwordMessage = document.getElementById('password-check-msg');
      const submitButton = document.getElementById('submit-btn');

      /*비밀번호 일치 여부체크 시작
      * 비밀번호가 서로 일치하면 버튼 enable
      * 비밀번호가 서로 일치하지않으면 disable
      * */
      confirmPassword.addEventListener('input', () => {
        if (password.value.trim() === "") {
          passwordMessage.textContent = "";
          return; //패스워드를 입력하지 않으면 텍스트가 표시 되지않는다.
        }
        if (confirmPassword.value === "") {
          passwordMessage.textContent = "";
          return; //패스워드를 입력하지 않으면 텍스트가 표시 되지않는다.
        }
        if (confirmPassword.value === password.value) {
          passwordMessage.textContent = "비밀번호가 일치합니다.";
          passwordMessage.style.color = "green";
          submitButton.disabled = false;

        } else {
          passwordMessage.textContent = "비밀번호가 일치하지 않습니다.";
          passwordMessage.style.color = "red";
          submitButton.disabled = true;
        }
      });
      // 비밀번호 체크 끝

      //제이쿼리벨리데이션 텍스트가 보이게되면 인증성공 , 실패 텍스트 숨김
      $('#verification-code').on('input' , function () {
         if ($('#verification-code-msg') !== '') {
           $('#verification-success-msg').hide();
           $('#verification-fail-msg').hide();
         }
      });

      /*
      인증번호전송 버튼을 클릭하면 이메일 입력칸에 공백이아니면
      인증확인 버튼 , 인증코드 입력란 활성화 하고

       */
      // $('#send-code-btn').on('click' , function () {
      //   const isEmailValid = $(`#email`).valid();
      //   console.log($('#email').val().trim() === '' || !isEmailValid)
      //   if ($('#email').val().trim() === '' && !isEmailValid) {
      //             $('#verify-code-btn').prop('disabled' , true);
      //            $('#verification-code').prop('disabled' , true);
      //   }
      //   $('#verify-code-btn').prop('disabled' , false);
      //   $('#verification-code').prop('disabled' , false);
      // });

      $('#verify-code-btn').on('click' , function () {
        const csrfToken = $('meta[name="_csrf"]').attr('content');
        const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
        const email = $('#email').val().trim(); //이메일 요청데이터
        const verificationCode = $('#verification-code').val().trim(); //인증번호 요청데이터
        let isEmailValid = $(`#email`).valid();
        let isVerificationCode = $(`#verification-code`).valid();
        const requestData = { //요청데이터
          email : email,
          verificationCode : verificationCode,
        }
        if (!isEmailValid || !isVerificationCode) { //만약 이메일입력란이 공백이거나 이메일형식이 아닌 텍스트(test.test.com)로 요청되었다고하면  isEmailValid 가 false 이므로 false 면 종료된다.
          return;
        }
        $.ajax({
          type: 'POST',
          url: '/api/member/verificationCode',
          contentType: 'application/json',
          data: JSON.stringify(requestData), //데이터 요청
          beforeSend: function (xhr) {
            xhr.setRequestHeader(csrfHeader, csrfToken); // CSRF 헤더 설정
          },
          success: function (response) {
            console.log(response);
            console.log(response.data);
            if (response.data) {
              $('#verification-success-msg').show(); //인증에 성공하였습니다. 출력
              $('#verification-fail-msg').hide(); //인증에 실패하였습니다. 숨김
              $('#verify-code-btn').prop('disabled' , true); // 인증성공 시 인증확인버튼 disable
              $('#verification-code').prop('disabled' , true);
            }
            else {
              $('#verification-fail-msg').show(); //인증에 실패하였습니다. 출력
              $('#verification-success-msg').hide(); //인증에 성공하였습니다. 숨김
              $('#verify-code-btn').prop('disabled' , false); // 인증실패 시 인증확인버튼 enable
              $('#verification-code').prop('disabled' , false);
            }
          },
          error: function () {
            alert("API 요청실패 , 서버확인필요");
          }
        });
      });
    </script>
  </th:block>
</div>
</html>